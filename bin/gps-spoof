#!/usr/bin/env node

require('../lib/banner')

const fs = require('fs')
const path = require('path')

const { program } = require('commander')
const { confirm } = require('@inquirer/prompts')

const hackrfTransmit = require('./hackrf-transmit')
const buildGpsSignalBinary = require('./build-gps-signal-binary')

const resolveFiles = require('../lib/resolveFiles')
const { PAYLOADS_DIRECTORY } = require('../lib/constants')

program
  .option('-p, --payload <file or path>', 'Payload, or payload directory', PAYLOADS_DIRECTORY)

module.exports = async (options = {}) => {
  const payloadFiles = await resolveFiles(options.payload)
  const rebuild = await confirm({ message: 'Build new payload now', default: !payloadFiles.length  })
  if (rebuild) await buildGpsSignalBinary({ ...options, gpssimOutput: options.payload })

  await hackrfTransmit({
    ...options,
    hrftxTransfer: options.payload,
    hrftxFrequency: 1575420000,
    hrftxSamplerate: 2600000,
    hrftxGain: 47,
    hrftxAmplify: true
  })
}

if (require.main === module) {
  program.parse()
  module.exports(program.opts())
}